HOST='localhost'
OPCION='vrfy'
while getopts 'u:h:d:vr' opcion
  do
    case "${opcion}" in 
      u) ARCHIVO=${OPTARG};;
      h) HOST=${OPTARG};;
      d) DESTINO=${OPTARG};;
      v) OPCION='vrfy';;
      r) OPCION='rcpt';; 
      *) exit;;
    esac
done
if [ ! -e $ARCHIVO ]
then
    echo "No se encuentra el archivo: \"$ARCHIVO\""
    exit
fi

while IFS= read -r user
do
    if [ $OPCION = 'vrfy' ]
    then
        echo "vrfy $user" | nc $HOST 25 | grep 252 | if [ `wc -l` -eq 1 ]; \
        then if [ -z $DESTINO ];then echo "Usuario encontrado: $user"; \
        else echo "Usuario encontrado con VRFY: $user" >> $DESTINO;echo "VRFY:Usuario $user guardado en '$DESTINO'";fi;fi
    elif [ $OPCION = 'rcpt' ]
    then
        (echo "mail from:$user";echo "rcpt to:$user") | nc $HOST 25 | grep 250 | if [ `wc -l` -eq 2 ];\
        then if [ -z $DESTINO ];then echo "Usuario encontrado con RCPT: $user";\
        else echo "Usuario encontrado con RCPT: $user" >> $DESTINO;echo "RCPT:Usuario $user guardado en '$DESTINO'";fi;fi
    fi
done < $ARCHIVO
